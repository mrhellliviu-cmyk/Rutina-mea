<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutina Mea</title>
  <meta name="theme-color" content="#2ecc71">
  <link rel="manifest" href="manifest.json" />

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px; }
    .card { background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    h1,h2{ margin:0 0 10px 0; }
    .muted{color:#666; font-size:14px;}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:#eef2f7; font-size:13px; margin-right:6px; margin-bottom:6px;}
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .row > *{flex:1; min-width:140px;}
    input, select, textarea { width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-top:6px; box-sizing:border-box;}
    button { width:100%; padding:12px; border:0; border-radius:8px; background:#2ecc71; color:#fff; font-size:16px; }
    .btn2{background:#1f2937;}
    .btnWarn{background:#e67e22;}
    .btnDanger{background:#e74c3c;}
    .mini{font-size:13px; padding:10px;}
    .ok{background:#e8fff0;}
    .warnBox{background:#fff7e6;}
    .list{margin:10px 0 0 0; padding:0; list-style:none;}
    .item{display:flex; gap:10px; align-items:center; padding:10px; border:1px solid #eee; border-radius:10px; margin-bottom:8px;}
    .item .grow{flex:1;}
    .amount{font-weight:bold;}
    .hr{height:1px; background:#eee; margin:10px 0;}
    .kbd{font-family: ui-monospace, Menlo, Consolas, monospace; background:#f2f2f2; padding:2px 6px; border-radius:6px;}
    .check { width:auto; transform: scale(1.1); margin-right:10px;}
  </style>
</head>

<body>
  <h1>ğŸ“… Rutina Mea</h1>
  <p id="date" class="muted"></p>

  <div class="card">
    <h2>â° Program</h2>
    <p>Trezire: <b>05:50</b></p>
    <p>Lucru: <b>07:00</b></p>
    <p class="muted">Start: 1 ianuarie 2026</p>
  </div>

  <!-- BUDGET -->
  <div class="card">
    <h2>ğŸ’° Buget (7 zile)</h2>
    <div class="row" style="margin-bottom:8px;">
      <span class="pill">Buget sÄƒptÄƒmÃ¢nal: <b id="weeklyBudgetLbl"></b></span>
      <span class="pill">Zi: <b id="dowLbl"></b></span>
      <span class="pill">Èšinta AZI: <b id="todayAllowanceLbl"></b></span>
    </div>

    <div class="row" style="margin-bottom:10px;">
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Cheltuit sÄƒptÄƒmÃ¢na asta</div>
        <div style="font-size:20px;"><b id="spentWeekLbl"></b></div>
      </div>
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">RÄƒmas sÄƒptÄƒmÃ¢na asta</div>
        <div style="font-size:20px;"><b id="remainWeekLbl"></b></div>
      </div>
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Cheltuit AZI</div>
        <div style="font-size:20px;"><b id="todaySpentLbl"></b></div>
      </div>
    </div>

    <p id="budgetNote" class="muted" style="margin:0;"></p>
  </div>

  <!-- EXPENSES MULTI -->
  <div class="card">
    <h2>ğŸ§¾ Cheltuieli azi (bonuri)</h2>
    <p class="muted" style="margin-top:0;">
      AdaugÄƒ fiecare bon separat. Totalul zilei se calculeazÄƒ singur.
    </p>

    <div class="row">
      <div>
        <label>Suma (â‚¬)</label>
        <input type="number" id="expAmount" placeholder="ex: 8.50" inputmode="decimal">
      </div>
      <div>
        <label>Categorie</label>
        <select id="expCat">
          <option value="MÃ¢ncare">MÃ¢ncare</option>
          <option value="BÄƒuturi">BÄƒuturi</option>
          <option value="Snack">Snack</option>
          <option value="Altele">Altele</option>
        </select>
      </div>
    </div>
    <label>NotÄƒ (opÈ›ional)</label>
    <input id="expNote" placeholder="ex: Lidl - pui + orez">

    <div style="height:10px"></div>
    <div class="row">
      <button id="addExpenseBtn">AdaugÄƒ bon</button>
      <button id="resetTodayBtn" class="btnWarn">Reset azi</button>
    </div>

    <ul id="todayList" class="list"></ul>

    <div class="row">
      <button id="exportCsvBtn" class="btn2 mini">Export CSV (7 zile)</button>
      <button id="clearAllBtn" class="btnDanger mini">È˜terge TOT (cu grijÄƒ)</button>
    </div>
    <p class="muted" style="margin-top:10px;">
      Tip: dacÄƒ ai introdus greÈ™it un bon, apasÄƒ <span class="kbd">X</span> la bonul respectiv.
    </p>
  </div>

  <!-- HISTORY 7 DAYS -->
  <div class="card">
    <h2>ğŸ“Š Istoric 7 zile</h2>
    <p class="muted" style="margin-top:0;">Ultimele 7 zile (azi inclus). Vezi totalul pe zi.</p>
    <ul id="historyList" class="list"></ul>
  </div>

  <!-- MEALS TODAY -->
  <div class="card">
    <h2>ğŸ³ Mese (azi)</h2>
    <p class="muted" style="margin-top:0;">
      Variat, simplu, mai sÄƒnÄƒtos. Ajustat dupÄƒ È›inta ta de azi.
    </p>

    <div class="row" style="margin-bottom:10px;">
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Èšinta AZI</div>
        <div style="font-size:18px;"><b id="mealBudgetLbl"></b></div>
      </div>
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Cheltuit AZI</div>
        <div style="font-size:18px;"><b id="mealSpentLbl"></b></div>
      </div>
    </div>

    <div id="mealsBox"></div>

    <div style="height:10px"></div>
    <div class="row">
      <button id="regenMealsBtn" class="btn2">SchimbÄƒ meniul (azi)</button>
      <button id="markMealsDoneBtn">BifeazÄƒ mesele (azi)</button>
    </div>
    <p id="mealsStatus" class="muted" style="margin-top:10px;"></p>
  </div>

  <!-- SHOPPING TOMORROW -->
  <div class="card warnBox">
    <h2>ğŸ›’ CumpÄƒrÄƒturi pentru MÃ‚INE</h2>
    <p class="muted" style="margin-top:0;">
      AplicaÈ›ia Ã®È›i genereazÄƒ meniul de mÃ¢ine + lista de cumpÄƒrÄƒturi. Bifezi È™i poÈ›i copia lista.
      (La 20:00 Ã®È›i aminteÈ™te cÃ¢nd aplicaÈ›ia e deschisÄƒ; pentru notificare sigurÄƒ foloseÈ™te Calendar.)
    </p>

    <div id="tomorrowMenuBox"></div>

    <div class="hr"></div>

    <div class="row" style="margin-bottom:10px;">
      <button id="regenTomorrowBtn" class="btn2">SchimbÄƒ meniul (mÃ¢ine)</button>
      <button id="copyShopBtn">CopiazÄƒ lista</button>
    </div>

    <ul id="shopList" class="list"></ul>

    <div class="row">
      <button id="clearShopChecksBtn" class="btn2 mini">DebifeazÄƒ tot</button>
      <button id="calShopBtn" class="btn2 mini">Calendar 20:00 (sigur)</button>
    </div>

    <p id="shopStatus" class="muted" style="margin-top:10px;"></p>
  </div>

  <!-- STREAK -->
  <div class="card">
    <h2>âœ… Ziua de azi (streak)</h2>
    <p class="muted" style="margin-top:0;">ApeÈ™i cÃ¢nd ai respectat ziua (fÄƒrÄƒ alcool / rutinÄƒ ok).</p>

    <div class="row" style="margin-bottom:10px;">
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Streak curent</div>
        <div style="font-size:22px;"><b id="streakLbl"></b> zile</div>
      </div>
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Ultima zi bifatÄƒ</div>
        <div style="font-size:16px;"><b id="lastDoneLbl"></b></div>
      </div>
    </div>

    <div class="row">
      <button id="doneBtn">Am respectat ziua</button>
      <button id="undoBtn" class="btn2">AnuleazÄƒ azi</button>
    </div>

    <p id="status" class="muted" style="margin-top:10px;"></p>
  </div>

<script>
  // ===== SETTINGS =====
  const WEEKLY_BUDGET = 50;

  // ===== HELPERS =====
  const money = (n) => `${Number(n || 0).toFixed(2)} â‚¬`;
  const pad = (n)=>String(n).padStart(2,"0");
  function ymd(d = new Date()) { return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function dayNameRo(d = new Date()) { return d.toLocaleDateString("ro-RO", { weekday: "long" }); }
  function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
  function loadJSON(key, fallback){ try { return JSON.parse(localStorage.getItem(key) || ""); } catch { return fallback; } }
  function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
  function weekStartMonday(d = new Date()){
    const x = new Date(d);
    const day = x.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    x.setDate(x.getDate() + diff);
    x.setHours(0,0,0,0);
    return x;
  }
  function escapeHtml(s){
    return String(s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  // ===== EXPENSES =====
  // expensesByDay: { "YYYY-MM-DD": [{id, amount, cat, note, ts}] }
  function cryptoId(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
  function getExpensesByDay(){ return loadJSON("expensesByDay", {}); }
  function setExpensesByDay(obj){ saveJSON("expensesByDay", obj); }
  function getTodayExpenses(){ const all = getExpensesByDay(); return Array.isArray(all[ymd()]) ? all[ymd()] : []; }
  function addExpense(amount, cat, note){
    const v = Number(amount);
    if (!isFinite(v) || v <= 0) return false;
    const all = getExpensesByDay();
    const k = ymd();
    if (!Array.isArray(all[k])) all[k] = [];
    all[k].unshift({ id: cryptoId(), amount: v, cat, note: note || "", ts: Date.now() });
    setExpensesByDay(all);
    return true;
  }
  function removeExpense(id){
    const all = getExpensesByDay();
    const k = ymd();
    all[k] = (all[k] || []).filter(x => x.id !== id);
    setExpensesByDay(all);
  }
  function resetToday(){
    const all = getExpensesByDay();
    all[ymd()] = [];
    setExpensesByDay(all);
    // reset meals done today
    const meals = loadJSON("mealsByDay", {});
    if (meals[ymd()]) meals[ymd()].done = false;
    saveJSON("mealsByDay", meals);
  }
  function totalForDay(dayKey){
    const all = getExpensesByDay();
    const arr = Array.isArray(all[dayKey]) ? all[dayKey] : [];
    return arr.reduce((s,x)=>s + Number(x.amount||0), 0);
  }
  function sumWeekSpends(refDate = new Date()){
    const start = weekStartMonday(refDate);
    let total = 0;
    for (let i=0;i<7;i++){
      const d = new Date(start);
      d.setDate(start.getDate()+i);
      total += totalForDay(ymd(d));
    }
    return total;
  }
  function daysRemainingInWeek(d = new Date()){
    const day = d.getDay();
    const idx = (day === 0) ? 6 : (day - 1);
    return 7 - idx; // include today
  }
  function calcTodayAllowance(){
    const spentWeek = sumWeekSpends(new Date());
    const remaining = Math.max(0, WEEKLY_BUDGET - spentWeek);
    const left = daysRemainingInWeek(new Date());
    return remaining / Math.max(1, left);
  }

  // ===== STREAK =====
  function getStreak(){ return loadJSON("streak", { count:0, lastDone:"" }); }
  function setStreak(s){ saveJSON("streak", s); }
  function daysBetween(aYmd, bYmd){
    const a = new Date(aYmd + "T00:00:00");
    const b = new Date(bYmd + "T00:00:00");
    return Math.round((b-a)/(1000*60*60*24));
  }
  function markDoneToday(){
    const today = ymd();
    const st = getStreak();
    if (!st.lastDone) { st.count=1; st.lastDone=today; setStreak(st); return; }
    if (st.lastDone === today) return;
    const diff = daysBetween(st.lastDone, today);
    st.count = (diff===1) ? (st.count+1) : 1;
    st.lastDone = today;
    setStreak(st);
  }
  function undoDoneToday(){
    const today = ymd();
    const st = getStreak();
    if (st.lastDone !== today) return;
    st.lastDone=""; st.count=0;
    setStreak(st);
  }

  // ===== MEALS =====
  const MEAL_POOL = {
    breakfast: [
      { t:"Iaurt grecesc + bananÄƒ + nuci", notes:"Rapid, proteine." },
      { t:"OmletÄƒ 2 ouÄƒ + roÈ™ii + pÃ¢ine integralÄƒ", notes:"Simplu." },
      { t:"OvÄƒz cu lapte + mÄƒr + scorÈ›iÈ™oarÄƒ", notes:"Energie stabilÄƒ." },
      { t:"Sandwich ton + salatÄƒ", notes:"Bun la muncÄƒ." }
    ],
    lunch: [
      { t:"Pui + orez + legume", notes:"Meal-prep." },
      { t:"Curcan + cartofi + salatÄƒ", notes:"SÄƒÈ›ios." },
      { t:"Paste integrale + sos roÈ™ii + ton", notes:"Ieftin È™i bun." },
      { t:"SalatÄƒ mare cu ou + brÃ¢nzÄƒ + pÃ¢ine", notes:"UÈ™or." }
    ],
    dinner: [
      { t:"PeÈ™te + legume la cuptor", notes:"UÈ™or seara." },
      { t:"SupÄƒ/cremÄƒ legume + pÃ¢ine", notes:"Calm pentru somn." },
      { t:"TocÄƒniÈ›Äƒ legume + carne slabÄƒ", notes:"Simplu." },
      { t:"Orez + ou + legume (stir-fry)", notes:"Rapid." }
    ]
  };

  // mapping: meal title -> shopping items (simple & practical)
  const SHOP_MAP = {
    "Iaurt grecesc + bananÄƒ + nuci": ["iaurt grecesc", "banane", "nuci/migdale"],
    "OmletÄƒ 2 ouÄƒ + roÈ™ii + pÃ¢ine integralÄƒ": ["ouÄƒ", "roÈ™ii", "pÃ¢ine integralÄƒ", "ulei/unt"],
    "OvÄƒz cu lapte + mÄƒr + scorÈ›iÈ™oarÄƒ": ["ovÄƒz", "lapte", "mere", "scorÈ›iÈ™oarÄƒ"],
    "Sandwich ton + salatÄƒ": ["ton conservÄƒ", "pÃ¢ine", "salatÄƒ", "porumb (opÈ›ional)", "iaurt/maionezÄƒ (opÈ›ional)"],

    "Pui + orez + legume": ["piept pui", "orez", "legume (mix)", "ulei", "condimente"],
    "Curcan + cartofi + salatÄƒ": ["curcan", "cartofi", "salatÄƒ", "roÈ™ii/castraveÈ›i", "ulei + oÈ›et"],
    "Paste integrale + sos roÈ™ii + ton": ["paste integrale", "roÈ™ii/sos", "ton conservÄƒ", "usturoi (opÈ›ional)"],
    "SalatÄƒ mare cu ou + brÃ¢nzÄƒ + pÃ¢ine": ["ouÄƒ", "brÃ¢nzÄƒ", "salatÄƒ", "pÃ¢ine", "roÈ™ii/castraveÈ›i"],

    "PeÈ™te + legume la cuptor": ["peÈ™te", "legume (broccoli/morcovi)", "lÄƒmÃ¢ie", "ulei", "condimente"],
    "SupÄƒ/cremÄƒ legume + pÃ¢ine": ["legume supÄƒ (morcovi/ceapÄƒ)", "cartofi", "smÃ¢ntÃ¢nÄƒ (opÈ›ional)", "pÃ¢ine"],
    "TocÄƒniÈ›Äƒ legume + carne slabÄƒ": ["carne slabÄƒ", "ceapÄƒ", "ardei", "roÈ™ii", "condimente"],
    "Orez + ou + legume (stir-fry)": ["orez", "ouÄƒ", "legume (mix)", "sos soia (opÈ›ional)"]
  };

  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
  }

  // mealsByDay: { "YYYY-MM-DD": { menu, done } }
  function getMealsByDay(){ return loadJSON("mealsByDay", {}); }
  function setMealsByDay(obj){ saveJSON("mealsByDay", obj); }

  function pickMenuForDate(dateObj, force=false){
    const k = ymd(dateObj);
    const all = getMealsByDay();
    if (!force && all[k] && all[k].menu) return all[k].menu;

    const seed = Number(k.split("-").join("")) || 1;
    const rng = mulberry32(seed);

    const menu = {
      breakfast: MEAL_POOL.breakfast[Math.floor(rng()*MEAL_POOL.breakfast.length)],
      lunch: MEAL_POOL.lunch[Math.floor(rng()*MEAL_POOL.lunch.length)],
      dinner: MEAL_POOL.dinner[Math.floor(rng()*MEAL_POOL.dinner.length)],
      tip: rng() > 0.5 ? "ApÄƒ + 10 min mers." : "FÄƒrÄƒ alcool azi. Doar ziua de azi."
    };

    all[k] = all[k] || { done:false };
    all[k].menu = menu;
    setMealsByDay(all);
    return menu;
  }

  function markMealsDoneToday(){
    const k = ymd();
    const all = getMealsByDay();
    all[k] = all[k] || {};
    all[k].done = true;
    setMealsByDay(all);
  }
  function mealsDoneToday(){
    const all = getMealsByDay();
    return !!(all[ymd()] && all[ymd()].done);
  }

  // ===== SHOPPING LIST =====
  // shopChecks: { "YYYY-MM-DD": { "item": true/false } } for tomorrow date key
  function getShopChecks(){ return loadJSON("shopChecks", {}); }
  function setShopChecks(obj){ saveJSON("shopChecks", obj); }

  function buildShoppingListForMenu(menu){
    const titles = [menu.breakfast.t, menu.lunch.t, menu.dinner.t];
    const items = [];
    for (const t of titles){
      const mapped = SHOP_MAP[t] || [];
      for (const it of mapped) items.push(it);
    }
    // dedupe + normalize
    const uniq = [...new Set(items.map(s => s.trim().toLowerCase()))]
      .filter(Boolean)
      .sort((a,b)=>a.localeCompare(b));
    return uniq;
  }

  async function tryNotifyAt20WhenOpen(){
    // when app is open, if time is >=20:00 and not fired today, show a notification
    if (!("Notification" in window)) return;
    if (Notification.permission !== "granted") return;

    const firedKey = "shopNotifFired";
    const today = ymd();
    const fired = loadJSON(firedKey, { date:"" });
    const now = new Date();

    if (fired.date === today) return;
    if (now.getHours() < 20) return;

    fired.date = today;
    saveJSON(firedKey, fired);

    const msg = "E 20:00 â€” verificÄƒ lista de cumpÄƒrÄƒturi pentru mÃ¢ine.";
    if ("serviceWorker" in navigator) {
      const reg = await navigator.serviceWorker.getRegistration();
      if (reg) reg.showNotification("Rutina Mea", { body: msg });
      else new Notification("Rutina Mea", { body: msg });
    } else {
      new Notification("Rutina Mea", { body: msg });
    }
  }

  // Calendar helper
  function addCalendarEvent(title, hh, mm) {
    const now = new Date();
    let start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0);
    let end = new Date(start.getTime()+10*60*1000);
    if (start < new Date()) { start.setDate(start.getDate()+1); end.setDate(end.getDate()+1); }
    const fmt = (d)=>`${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`;
    const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Rutina Mea//RO
BEGIN:VEVENT
DTSTART:${fmt(start)}
DTEND:${fmt(end)}
RRULE:FREQ=DAILY
SUMMARY:${title}
DESCRIPTION:Rutina Mea reminder
END:VEVENT
END:VCALENDAR`;
    const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "rutina-mea.ics";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  async function enableNotifications(){
    if (!("Notification" in window)) return { ok:false, msg:"NotificÄƒrile nu sunt suportate aici." };
    const perm = await Notification.requestPermission();
    if (perm !== "granted") return { ok:false, msg:"Permisiunea nu a fost acordatÄƒ." };
    return { ok:true, msg:"NotificÄƒrile sunt activate." };
  }

  // ===== UI refs =====
  const dateEl = document.getElementById("date");
  const weeklyBudgetLbl = document.getElementById("weeklyBudgetLbl");
  const dowLbl = document.getElementById("dowLbl");
  const spentWeekLbl = document.getElementById("spentWeekLbl");
  const remainWeekLbl = document.getElementById("remainWeekLbl");
  const todayAllowanceLbl = document.getElementById("todayAllowanceLbl");
  const todaySpentLbl = document.getElementById("todaySpentLbl");
  const budgetNote = document.getElementById("budgetNote");
  const todayList = document.getElementById("todayList");
  const historyList = document.getElementById("historyList");

  const streakLbl = document.getElementById("streakLbl");
  const lastDoneLbl = document.getElementById("lastDoneLbl");
  const statusEl = document.getElementById("status");

  const mealsBox = document.getElementById("mealsBox");
  const mealsStatus = document.getElementById("mealsStatus");
  const mealBudgetLbl = document.getElementById("mealBudgetLbl");
  const mealSpentLbl = document.getElementById("mealSpentLbl");

  // shopping refs
  const tomorrowMenuBox = document.getElementById("tomorrowMenuBox");
  const shopListEl = document.getElementById("shopList");
  const shopStatusEl = document.getElementById("shopStatus");

  // ===== Render helpers =====
  function itemsCountText(dayKey){
    const all = getExpensesByDay();
    const arr = Array.isArray(all[dayKey]) ? all[dayKey] : [];
    return arr.length ? `${arr.length} bon(uri)` : `0 bonuri`;
  }

  function renderMenu(menu){
    return `
      <div class="card" style="margin:0 0 10px 0; box-shadow:none;">
        <b>Mic dejun:</b> ${escapeHtml(menu.breakfast.t)}<br>
        <span class="muted">${escapeHtml(menu.breakfast.notes)}</span>
      </div>
      <div class="card" style="margin:0 0 10px 0; box-shadow:none;">
        <b>PrÃ¢nz:</b> ${escapeHtml(menu.lunch.t)}<br>
        <span class="muted">${escapeHtml(menu.lunch.notes)}</span>
      </div>
      <div class="card" style="margin:0; box-shadow:none;">
        <b>CinÄƒ:</b> ${escapeHtml(menu.dinner.t)}<br>
        <span class="muted">${escapeHtml(menu.dinner.notes)}</span><br>
        <div class="hr"></div>
        <b>Tip:</b> ${escapeHtml(menu.tip)}
      </div>
    `;
  }

  function renderTomorrowMenu(menu, dateObj){
    const label = `${ymd(dateObj)} (${dayNameRo(dateObj)})`;
    return `
      <div class="pill">MÃ¢ine: <b>${label}</b></div>
      <div class="hr"></div>
      ${renderMenu(menu)}
    `;
  }

  function renderShoppingList(items, dateKey){
    const checksAll = getShopChecks();
    const checks = checksAll[dateKey] || {};
    shopListEl.innerHTML = "";

    if (!items.length) {
      shopListEl.innerHTML = `<li class="muted">Nu am gÄƒsit ingrediente pentru meniul Äƒsta.</li>`;
      return;
    }

    let done = 0;
    for (const it of items){
      const checked = !!checks[it];
      if (checked) done++;

      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `
        <input class="check" type="checkbox" ${checked ? "checked" : ""} data-item="${escapeHtml(it)}">
        <div class="grow"><b>${escapeHtml(it)}</b></div>
      `;
      shopListEl.appendChild(li);
    }

    shopListEl.querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.addEventListener("change", () => {
        const item = cb.getAttribute("data-item");
        const all = getShopChecks();
        all[dateKey] = all[dateKey] || {};
        all[dateKey][item] = cb.checked;
        setShopChecks(all);
        render(); // update progress text
      });
    });

    shopStatusEl.textContent = `Bifate: ${done}/${items.length}`;
  }

  // ===== Main render =====
  async function render(){
    dateEl.textContent = new Date().toLocaleDateString("ro-RO", { weekday:"long", year:"numeric", month:"long", day:"numeric" });

    weeklyBudgetLbl.textContent = money(WEEKLY_BUDGET);
    dowLbl.textContent = dayNameRo(new Date());

    const spentWeek = sumWeekSpends(new Date());
    const remainWeek = Math.max(0, WEEKLY_BUDGET - spentWeek);
    const todaySpend = totalForDay(ymd());
    const allowance = calcTodayAllowance();

    spentWeekLbl.textContent = money(spentWeek);
    remainWeekLbl.textContent = money(remainWeek);
    todayAllowanceLbl.textContent = money(allowance);
    todaySpentLbl.textContent = money(todaySpend);

    if (todaySpend > allowance) budgetNote.textContent = `Azi ai depÄƒÈ™it È›inta cu ${money(todaySpend - allowance)}. MÃ¢ine compensezi uÈ™or.`;
    else budgetNote.textContent = `EÈ™ti bine: sub È›inta de azi cu ${money(allowance - todaySpend)}.`;

    // today expenses list
    const items = getTodayExpenses();
    todayList.innerHTML = "";
    if (!items.length) {
      todayList.innerHTML = `<li class="muted">Nu ai bonuri azi (Ã®ncÄƒ).</li>`;
    } else {
      for (const it of items) {
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `
          <div class="grow">
            <div><span class="amount">${money(it.amount)}</span> <span class="pill">${escapeHtml(it.cat)}</span></div>
            <div class="muted">${escapeHtml(it.note || "â€”")}</div>
          </div>
          <button class="btnDanger mini" data-id="${it.id}" style="width:auto;">X</button>
        `;
        todayList.appendChild(li);
      }
      todayList.querySelectorAll("button[data-id]").forEach(btn => {
        btn.addEventListener("click", () => { removeExpense(btn.getAttribute("data-id")); render(); });
      });
    }

    // history 7 days
    const now = new Date();
    historyList.innerHTML = "";
    for (let i=0;i<7;i++){
      const d = new Date(now);
      d.setDate(now.getDate() - i);
      const k = ymd(d);
      const t = totalForDay(k);
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `
        <div class="grow">
          <div><b>${k}</b> <span class="pill">${dayNameRo(d)}</span></div>
          <div class="muted">${itemsCountText(k)}</div>
        </div>
        <div class="amount">${money(t)}</div>
      `;
      historyList.appendChild(li);
    }

    // meals today
    const menuToday = pickMenuForDate(new Date(), false);
    mealsBox.innerHTML = renderMenu(menuToday);
    mealBudgetLbl.textContent = money(allowance);
    mealSpentLbl.textContent = money(todaySpend);
    mealsStatus.textContent = mealsDoneToday() ? "âœ” Mesele sunt bifate azi." : "Mesele nu sunt bifate Ã®ncÄƒ.";

    // meals tomorrow + shopping list
    const tomorrow = addDays(new Date(), 1);
    const menuTomorrow = pickMenuForDate(tomorrow, false);
    tomorrowMenuBox.innerHTML = renderTomorrowMenu(menuTomorrow, tomorrow);

    const shopItems = buildShoppingListForMenu(menuTomorrow);
    renderShoppingList(shopItems, ymd(tomorrow));

    // streak
    const st = getStreak();
    streakLbl.textContent = String(st.count || 0);
    lastDoneLbl.textContent = st.lastDone ? st.lastDone : "â€”";
    statusEl.textContent = st.lastDone === ymd() ? "âœ” Azi e bifatÄƒ. Èšine ritmul." : "ÃncÄƒ nu ai bifat azi.";

    // try a 20:00 reminder when open (if allowed)
    await tryNotifyAt20WhenOpen();
  }

  // ===== Actions =====
  document.getElementById("addExpenseBtn").addEventListener("click", () => {
    const amount = document.getElementById("expAmount").value;
    const cat = document.getElementById("expCat").value;
    const note = document.getElementById("expNote").value;
    const ok = addExpense(amount, cat, note);
    if (!ok) return;
    document.getElementById("expAmount").value = "";
    document.getElementById("expNote").value = "";
    render();
  });

  document.getElementById("resetTodayBtn").addEventListener("click", () => { resetToday(); render(); });

  document.getElementById("exportCsvBtn").addEventListener("click", () => {
    // keep previous behavior via CSV export
    const today = new Date();
    const rows = [["date","total","items"]];
    for (let i=6;i>=0;i--){
      const d = new Date(today);
      d.setDate(today.getDate()-i);
      const k = ymd(d);
      const all = getExpensesByDay();
      const arr = (all[k]||[]);
      const items = arr.map(x => `${x.cat}:${x.amount}${x.note?`(${x.note})`:""}`).join(" | ");
      rows.push([k, String(totalForDay(k).toFixed(2)), `"${items.replaceAll('"','""')}"`]);
    }
    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "rutina-mea-7zile.csv";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  });

  document.getElementById("clearAllBtn").addEventListener("click", () => {
    const key = "clearAllArmed";
    const armed = localStorage.getItem(key) === "1";
    if (!armed) { localStorage.setItem(key,"1"); alert("AtenÈ›ie: apasÄƒ Ã®ncÄƒ o datÄƒ pe â€È˜terge TOTâ€ ca sÄƒ confirmi."); return; }
    localStorage.removeItem(key);
    localStorage.removeItem("expensesByDay");
    localStorage.removeItem("streak");
    localStorage.removeItem("mealsByDay");
    localStorage.removeItem("shopChecks");
    render();
  });

  document.getElementById("regenMealsBtn").addEventListener("click", () => { pickMenuForDate(new Date(), true); render(); });
  document.getElementById("markMealsDoneBtn").addEventListener("click", () => { markMealsDoneToday(); render(); });

  document.getElementById("doneBtn").addEventListener("click", () => { markDoneToday(); render(); });
  document.getElementById("undoBtn").addEventListener("click", () => { undoDoneToday(); render(); });

  // Shopping actions
  document.getElementById("regenTomorrowBtn").addEventListener("click", () => {
    const tomorrow = addDays(new Date(), 1);
    pickMenuForDate(tomorrow, true);
    render();
  });

  document.getElementById("copyShopBtn").addEventListener("click", async () => {
    const tomorrow = addDays(new Date(), 1);
    const menuTomorrow = pickMenuForDate(tomorrow, false);
    const items = buildShoppingListForMenu(menuTomorrow);
    const text = [
      `CumpÄƒrÄƒturi pentru ${ymd(tomorrow)} (${dayNameRo(tomorrow)}):`,
      ...items.map(x => `- ${x}`)
    ].join("\n");
    try {
      await navigator.clipboard.writeText(text);
      shopStatusEl.textContent = "âœ… ListÄƒ copiatÄƒ.";
    } catch {
      shopStatusEl.textContent = "Nu am putut copia automat. (Ãn unele browsere e blocat.)";
      alert(text);
    }
  });

  document.getElementById("clearShopChecksBtn").addEventListener("click", () => {
    const tomorrow = addDays(new Date(), 1);
    const key = ymd(tomorrow);
    const all = getShopChecks();
    all[key] = {};
    setShopChecks(all);
    render();
  });

  document.getElementById("calShopBtn").addEventListener("click", () => addCalendarEvent("Rutina Mea â€” CumpÄƒrÄƒturi 20:00", 20, 0));

  // Notifications permission (optional)
  // (You can add a button later if you want, but this keeps it clean.)

  // Service worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  render();
</script>
</body>
</html><!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutina Mea</title>
  <meta name="theme-color" content="#2ecc71">
  <link rel="manifest" href="manifest.json" />

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px; }
    .card { background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    h1,h2{ margin:0 0 10px 0; }
    .muted{color:#666; font-size:14px;}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:#eef2f7; font-size:13px; margin-right:6px; margin-bottom:6px;}
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .row > *{flex:1; min-width:140px;}
    input, select, textarea { width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-top:6px; box-sizing:border-box;}
    button { width:100%; padding:12px; border:0; border-radius:8px; background:#2ecc71; color:#fff; font-size:16px; }
    .btn2{background:#1f2937;}
    .btnWarn{background:#e67e22;}
    .btnDanger{background:#e74c3c;}
    .mini{font-size:13px; padding:10px;}
    .ok{background:#e8fff0;}
    .warnBox{background:#fff7e6;}
    .list{margin:10px 0 0 0; padding:0; list-style:none;}
    .item{display:flex; gap:10px; align-items:center; padding:10px; border:1px solid #eee; border-radius:10px; margin-bottom:8px;}
    .item .grow{flex:1;}
    .amount{font-weight:bold;}
    .hr{height:1px; background:#eee; margin:10px 0;}
    .kbd{font-family: ui-monospace, Menlo, Consolas, monospace; background:#f2f2f2; padding:2px 6px; border-radius:6px;}
  </style>
</head>

<body>
  <h1>ğŸ“… Rutina Mea</h1>
  <p id="date" class="muted"></p>

  <div class="card">
    <h2>â° Program</h2>
    <p>Trezire: <b>05:50</b></p>
    <p>Lucru: <b>07:00</b></p>
    <p class="muted">Start: 1 ianuarie 2026</p>
  </div>

  <!-- BUDGET -->
  <div class="card">
    <h2>ğŸ’° Buget (7 zile)</h2>
    <div class="row" style="margin-bottom:8px;">
      <span class="pill">Buget sÄƒptÄƒmÃ¢nal: <b id="weeklyBudgetLbl"></b></span>
      <span class="pill">Zi: <b id="dowLbl"></b></span>
      <span class="pill">Èšinta AZI: <b id="todayAllowanceLbl"></b></span>
    </div>

    <div class="row" style="margin-bottom:10px;">
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Cheltuit sÄƒptÄƒmÃ¢na asta</div>
        <div style="font-size:20px;"><b id="spentWeekLbl"></b></div>
      </div>
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">RÄƒmas sÄƒptÄƒmÃ¢na asta</div>
        <div style="font-size:20px;"><b id="remainWeekLbl"></b></div>
      </div>
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Cheltuit AZI</div>
        <div style="font-size:20px;"><b id="todaySpentLbl"></b></div>
      </div>
    </div>

    <p id="budgetNote" class="muted" style="margin:0;"></p>
  </div>

  <!-- EXPENSES MULTI -->
  <div class="card">
    <h2>ğŸ§¾ Cheltuieli azi (bonuri)</h2>
    <p class="muted" style="margin-top:0;">
      AdaugÄƒ fiecare bon separat. Totalul zilei se calculeazÄƒ singur.
    </p>

    <div class="row">
      <div>
        <label>Suma (â‚¬)</label>
        <input type="number" id="expAmount" placeholder="ex: 8.50" inputmode="decimal">
      </div>
      <div>
        <label>Categorie</label>
        <select id="expCat">
          <option value="MÃ¢ncare">MÃ¢ncare</option>
          <option value="BÄƒuturi">BÄƒuturi</option>
          <option value="Snack">Snack</option>
          <option value="Altele">Altele</option>
        </select>
      </div>
    </div>
    <label>NotÄƒ (opÈ›ional)</label>
    <input id="expNote" placeholder="ex: Lidl - pui + orez">

    <div style="height:10px"></div>
    <div class="row">
      <button id="addExpenseBtn">AdaugÄƒ bon</button>
      <button id="resetTodayBtn" class="btnWarn">Reset azi</button>
    </div>

    <ul id="todayList" class="list"></ul>

    <div class="row">
      <button id="exportCsvBtn" class="btn2 mini">Export CSV (7 zile)</button>
      <button id="clearAllBtn" class="btnDanger mini">È˜terge TOT (cu grijÄƒ)</button>
    </div>
    <p class="muted" style="margin-top:10px;">
      Tip: dacÄƒ ai introdus greÈ™it un bon, apasÄƒ <span class="kbd">X</span> la bonul respectiv.
    </p>
  </div>

  <!-- HISTORY 7 DAYS -->
  <div class="card">
    <h2>ğŸ“Š Istoric 7 zile</h2>
    <p class="muted" style="margin-top:0;">Ultimele 7 zile (azi inclus). Vezi totalul pe zi.</p>
    <ul id="historyList" class="list"></ul>
  </div>

  <!-- MEALS -->
  <div class="card">
    <h2>ğŸ³ Mese (azi)</h2>
    <p class="muted" style="margin-top:0;">
      Variat, simplu, mai sÄƒnÄƒtos. Ajustat dupÄƒ È›inta ta de azi.
    </p>

    <div class="row" style="margin-bottom:10px;">
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Èšinta AZI</div>
        <div style="font-size:18px;"><b id="mealBudgetLbl"></b></div>
      </div>
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Cheltuit AZI</div>
        <div style="font-size:18px;"><b id="mealSpentLbl"></b></div>
      </div>
    </div>

    <div id="mealsBox"></div>

    <div style="height:10px"></div>
    <div class="row">
      <button id="regenMealsBtn" class="btn2">SchimbÄƒ meniul (azi)</button>
      <button id="markMealsDoneBtn">BifeazÄƒ mesele (azi)</button>
    </div>
    <p id="mealsStatus" class="muted" style="margin-top:10px;"></p>
  </div>

  <!-- STREAK -->
  <div class="card">
    <h2>âœ… Ziua de azi (streak)</h2>
    <p class="muted" style="margin-top:0;">ApeÈ™i cÃ¢nd ai respectat ziua (fÄƒrÄƒ alcool / rutinÄƒ ok).</p>

    <div class="row" style="margin-bottom:10px;">
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Streak curent</div>
        <div style="font-size:22px;"><b id="streakLbl"></b> zile</div>
      </div>
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Ultima zi bifatÄƒ</div>
        <div style="font-size:16px;"><b id="lastDoneLbl"></b></div>
      </div>
    </div>

    <div class="row">
      <button id="doneBtn">Am respectat ziua</button>
      <button id="undoBtn" class="btn2">AnuleazÄƒ azi</button>
    </div>

    <p id="status" class="muted" style="margin-top:10px;"></p>
  </div>

  <!-- WEEKLY REPORT -->
  <div class="card warnBox">
    <h2>ğŸ—“ Raport sÄƒptÄƒmÃ¢nal</h2>
    <p class="muted" style="margin-top:0;">
      Raportul apare automat duminicÄƒ (sau cÃ¢nd se schimbÄƒ sÄƒptÄƒmÃ¢na) cÃ¢nd deschizi aplicaÈ›ia.
    </p>
    <div id="weeklyReportBox" class="muted"></div>
    <div style="height:10px"></div>
    <button id="forceReportBtn" class="btn2">AratÄƒ raport acum</button>
  </div>

  <!-- NOTIFS (LIMITED) -->
  <div class="card">
    <h2>ğŸ”” NotificÄƒri</h2>
    <p class="muted" style="margin-top:0;">
      FÄƒrÄƒ server, notificÄƒrile programate cÃ¢nd aplicaÈ›ia e Ã®nchisÄƒ nu sunt mereu garantate.
      SoluÈ›ia sigurÄƒ: butoanele de Calendar (notificÄƒri reale).
    </p>

    <div class="row" style="margin-bottom:10px;">
      <button id="enableNotifsBtn">ActiveazÄƒ notificÄƒrile</button>
      <button id="testNotifBtn" class="btn2">Test notificare</button>
    </div>

    <div class="row">
      <button id="calWakeBtn" class="btn2">Calendar 05:50</button>
      <button id="calDinnerBtn" class="btn2">Calendar 18:00</button>
    </div>
    <div style="height:10px"></div>
    <button id="calShopBtn" class="btn2">Calendar 20:00</button>

    <p id="notifStatus" class="muted" style="margin-top:10px;"></p>
  </div>

<script>
  // ===== SETTINGS =====
  const WEEKLY_BUDGET = 50;

  // ===== HELPERS =====
  const money = (n) => `${Number(n || 0).toFixed(2)} â‚¬`;
  const pad = (n)=>String(n).padStart(2,"0");

  function ymd(d = new Date()) {
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function dayNameRo(d = new Date()) {
    return d.toLocaleDateString("ro-RO", { weekday: "long" });
  }
  function weekStartMonday(d = new Date()) {
    const x = new Date(d);
    const day = x.getDay(); // 0 Sun .. 6 Sat
    const diff = (day === 0 ? -6 : 1 - day);
    x.setDate(x.getDate() + diff);
    x.setHours(0,0,0,0);
    return x;
  }
  function weekIdForDate(d = new Date()) {
    const ws = weekStartMonday(d);
    return ymd(ws); // key
  }
  function loadJSON(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key) || ""); }
    catch { return fallback; }
  }
  function saveJSON(key, obj) {
    localStorage.setItem(key, JSON.stringify(obj));
  }

  // ===== DATA =====
  // expensesByDay: { "YYYY-MM-DD": [{id, amount, cat, note, ts}] }
  // streak: { count, lastDone }
  // mealsByDay: { "YYYY-MM-DD": { menu: {...}, done: boolean } }
  // meta: { lastSeenYmd, lastWeekId, lastReportedWeekId }

  function ensureMeta() {
    const meta = loadJSON("meta", { lastSeenYmd:"", lastWeekId:"", lastReportedWeekId:"" });
    const today = ymd();
    const wk = weekIdForDate(new Date());
    if (!meta.lastSeenYmd) meta.lastSeenYmd = today;
    if (!meta.lastWeekId) meta.lastWeekId = wk;
    saveJSON("meta", meta);
    return meta;
  }

  function getExpensesByDay(){ return loadJSON("expensesByDay", {}); }
  function setExpensesByDay(obj){ saveJSON("expensesByDay", obj); }

  function getTodayExpenses() {
    const all = getExpensesByDay();
    return Array.isArray(all[ymd()]) ? all[ymd()] : [];
  }

  function addExpense(amount, cat, note) {
    const v = Number(amount);
    if (!isFinite(v) || v <= 0) return false;
    const all = getExpensesByDay();
    const k = ymd();
    if (!Array.isArray(all[k])) all[k] = [];
    all[k].unshift({ id: cryptoId(), amount: v, cat, note: note || "", ts: Date.now() });
    setExpensesByDay(all);
    return true;
  }

  function removeExpense(id) {
    const all = getExpensesByDay();
    const k = ymd();
    all[k] = (all[k] || []).filter(x => x.id !== id);
    setExpensesByDay(all);
  }

  function resetToday() {
    const all = getExpensesByDay();
    all[ymd()] = [];
    setExpensesByDay(all);
    // also meals "done" resets? keep meals, but mark not done
    const meals = loadJSON("mealsByDay", {});
    if (meals[ymd()]) meals[ymd()].done = false;
    saveJSON("mealsByDay", meals);
  }

  function cryptoId() {
    // simple id
    return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }

  function totalForDay(dayKey) {
    const all = getExpensesByDay();
    const arr = Array.isArray(all[dayKey]) ? all[dayKey] : [];
    return arr.reduce((s,x)=>s + Number(x.amount||0), 0);
  }

  function sumWeekSpends(refDate = new Date()) {
    const start = weekStartMonday(refDate);
    let total = 0;
    for (let i=0; i<7; i++){
      const d = new Date(start);
      d.setDate(start.getDate()+i);
      total += totalForDay(ymd(d));
    }
    return total;
  }

  function daysRemainingInWeek(d = new Date()) {
    const day = d.getDay(); // 0 Sun .. 6 Sat
    const idx = (day === 0) ? 6 : (day - 1); // Mon=0 .. Sun=6
    return 7 - idx; // include today
  }

  function calcTodayAllowance() {
    const spentWeek = sumWeekSpends(new Date());
    const remaining = Math.max(0, WEEKLY_BUDGET - spentWeek);
    const left = daysRemainingInWeek(new Date());
    return remaining / Math.max(1, left);
  }

  // ===== STREAK =====
  function getStreak(){ return loadJSON("streak", { count:0, lastDone:"" }); }
  function setStreak(s){ saveJSON("streak", s); }
  function daysBetween(aYmd, bYmd) {
    const a = new Date(aYmd + "T00:00:00");
    const b = new Date(bYmd + "T00:00:00");
    return Math.round((b-a)/(1000*60*60*24));
  }
  function markDoneToday() {
    const today = ymd();
    const st = getStreak();
    if (!st.lastDone) { st.count=1; st.lastDone=today; setStreak(st); return; }
    if (st.lastDone === today) return;
    const diff = daysBetween(st.lastDone, today);
    st.count = (diff===1) ? (st.count+1) : 1;
    st.lastDone = today;
    setStreak(st);
  }
  function undoDoneToday() {
    const today = ymd();
    const st = getStreak();
    if (st.lastDone !== today) return;
    st.lastDone=""; st.count=0;
    setStreak(st);
  }

  // ===== MEALS =====
  // simple pool (variety + healthy-ish)
  const MEAL_POOL = {
    breakfast: [
      { t:"Iaurt grecesc + bananÄƒ + nuci", notes:"Rapid, proteine." },
      { t:"OmletÄƒ 2 ouÄƒ + roÈ™ii + pÃ¢ine integralÄƒ", notes:"Simplu." },
      { t:"OvÄƒz cu lapte + mÄƒr + scorÈ›iÈ™oarÄƒ", notes:"Energie stabilÄƒ." },
      { t:"Sandwich ton + salatÄƒ", notes:"Pentru muncÄƒ e top." }
    ],
    lunch: [
      { t:"Pui la tigaie + orez + legume", notes:"Meal-prep." },
      { t:"Curcan + cartofi + salatÄƒ", notes:"SÄƒÈ›ios." },
      { t:"Paste integrale + sos roÈ™ii + ton", notes:"Ieftin È™i bun." },
      { t:"SalatÄƒ mare cu ou + brÃ¢nzÄƒ + pÃ¢ine", notes:"UÈ™or." }
    ],
    dinner: [
      { t:"PeÈ™te + legume la cuptor", notes:"UÈ™or seara." },
      { t:"SupÄƒ/cremÄƒ legume + pÃ¢ine", notes:"Calm pentru somn." },
      { t:"TocÄƒniÈ›Äƒ de legume + carne slabÄƒ", notes:"Simplu." },
      { t:"Orez + ou + legume (stir-fry)", notes:"Rapid." }
    ]
  };

  function getMealsByDay(){ return loadJSON("mealsByDay", {}); }
  function setMealsByDay(obj){ saveJSON("mealsByDay", obj); }

  function pickMenuForToday(force=false) {
    const k = ymd();
    const all = getMealsByDay();
    if (!force && all[k] && all[k].menu) return all[k].menu;

    // deterministic-ish shuffle by date seed
    const seed = k.split("-").join("");
    const rng = mulberry32(Number(seed) || 1);
    const menu = {
      breakfast: MEAL_POOL.breakfast[Math.floor(rng()*MEAL_POOL.breakfast.length)],
      lunch: MEAL_POOL.lunch[Math.floor(rng()*MEAL_POOL.lunch.length)],
      dinner: MEAL_POOL.dinner[Math.floor(rng()*MEAL_POOL.dinner.length)],
      tip: rng() > 0.5 ? "ApÄƒ + 10 min mers." : "FÄƒrÄƒ alcool azi. Doar ziua de azi."
    };

    all[k] = all[k] || { done:false };
    all[k].menu = menu;
    setMealsByDay(all);
    return menu;
  }

  function markMealsDoneToday() {
    const k = ymd();
    const all = getMealsByDay();
    all[k] = all[k] || {};
    all[k].done = true;
    setMealsByDay(all);
  }
  function mealsDoneToday() {
    const all = getMealsByDay();
    return !!(all[ymd()] && all[ymd()].done);
  }

  function mulberry32(a) {
    return function() {
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
  }

  // ===== WEEKLY REPORT =====
  function buildWeeklyReport(weekStartKey) {
    // weekStartKey is ymd(Monday)
    const start = new Date(weekStartKey + "T00:00:00");
    const days = [];
    let total = 0;
    for (let i=0;i<7;i++){
      const d = new Date(start);
      d.setDate(start.getDate()+i);
      const k = ymd(d);
      const t = totalForDay(k);
      total += t;
      days.push({ k, t });
    }
    const remain = WEEKLY_BUDGET - total;
    const best = [...days].sort((a,b)=>a.t-b.t)[0];
    const worst = [...days].sort((a,b)=>b.t-a.t)[0];
    return { weekStartKey, total, remain, best, worst, days };
  }

  function maybeShowWeeklyReport(meta) {
    const currentWeek = weekIdForDate(new Date());
    const lastWeek = meta.lastWeekId;
    const today = new Date();
    const isSunday = (today.getDay() === 0);

    // Show if:
    // - Sunday after 18:00 and not yet reported this week
    // - or week changed (new week) and last week not reported
    const shouldSunday = isSunday && today.getHours() >= 18 && meta.lastReportedWeekId !== currentWeek;
    const weekChanged = (lastWeek && lastWeek !== currentWeek && meta.lastReportedWeekId !== lastWeek);

    if (shouldSunday) return { show:true, weekKey: currentWeek };
    if (weekChanged) return { show:true, weekKey: lastWeek };
    return { show:false, weekKey: currentWeek };
  }

  function renderWeeklyReport(weekKey) {
    const rep = buildWeeklyReport(weekKey);
    const box = document.getElementById("weeklyReportBox");

    const s = rep.remain >= 0
      ? `âœ… Ai rÄƒmas Ã®n buget cu ${money(rep.remain)}.`
      : `âš ï¸ Ai depÄƒÈ™it bugetul cu ${money(-rep.remain)}.`;

    const lines = rep.days.map(d => `â€¢ ${d.k}: ${money(d.t)}`).join("<br>");
    box.innerHTML = `
      <b>SÄƒptÄƒmÃ¢na (Luni) ${rep.weekStartKey}</b><br>
      Total: <b>${money(rep.total)}</b> din ${money(WEEKLY_BUDGET)}<br>
      ${s}<br><br>
      <b>Pe zile:</b><br>${lines}<br><br>
      Minim: <b>${rep.best.k}</b> (${money(rep.best.t)})<br>
      Maxim: <b>${rep.worst.k}</b> (${money(rep.worst.t)})
    `;
  }

  // ===== EXPORT CSV =====
  function exportCsv7Days() {
    const today = new Date();
    const rows = [["date","total","items"]];
    for (let i=6;i>=0;i--){
      const d = new Date(today);
      d.setDate(today.getDate()-i);
      const k = ymd(d);
      const all = getExpensesByDay();
      const items = (all[k]||[]).map(x => `${x.cat}:${x.amount}${x.note?`(${x.note})`:""}`).join(" | ");
      rows.push([k, String(totalForDay(k).toFixed(2)), `"${items.replaceAll('"','""')}"`]);
    }
    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "rutina-mea-7zile.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  // ===== NOTIFS (limited) + Calendar =====
  async function enableNotifications() {
    if (!("Notification" in window)) return { ok:false, msg:"NotificÄƒrile nu sunt suportate aici." };
    const perm = await Notification.requestPermission();
    if (perm !== "granted") return { ok:false, msg:"Permisiunea nu a fost acordatÄƒ." };
    return { ok:true, msg:"NotificÄƒrile sunt activate." };
  }
  function addCalendarEvent(title, hh, mm) {
    const now = new Date();
    let start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0);
    let end = new Date(start.getTime()+10*60*1000);
    if (start < new Date()) { start.setDate(start.getDate()+1); end.setDate(end.getDate()+1); }
    const fmt = (d)=>`${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`;
    const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Rutina Mea//RO
BEGIN:VEVENT
DTSTART:${fmt(start)}
DTEND:${fmt(end)}
RRULE:FREQ=DAILY
SUMMARY:${title}
DESCRIPTION:Rutina Mea reminder
END:VEVENT
END:VCALENDAR`;
    const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "rutina-mea.ics";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  // ===== UI refs =====
  const dateEl = document.getElementById("date");
  const weeklyBudgetLbl = document.getElementById("weeklyBudgetLbl");
  const dowLbl = document.getElementById("dowLbl");
  const spentWeekLbl = document.getElementById("spentWeekLbl");
  const remainWeekLbl = document.getElementById("remainWeekLbl");
  const todayAllowanceLbl = document.getElementById("todayAllowanceLbl");
  const todaySpentLbl = document.getElementById("todaySpentLbl");
  const budgetNote = document.getElementById("budgetNote");
  const todayList = document.getElementById("todayList");
  const historyList = document.getElementById("historyList");

  const streakLbl = document.getElementById("streakLbl");
  const lastDoneLbl = document.getElementById("lastDoneLbl");
  const statusEl = document.getElementById("status");

  const mealsBox = document.getElementById("mealsBox");
  const mealsStatus = document.getElementById("mealsStatus");
  const mealBudgetLbl = document.getElementById("mealBudgetLbl");
  const mealSpentLbl = document.getElementById("mealSpentLbl");

  const notifStatus = document.getElementById("notifStatus");

  function render() {
    const meta = ensureMeta();

    // header date
    dateEl.textContent = new Date().toLocaleDateString("ro-RO", { weekday:"long", year:"numeric", month:"long", day:"numeric" });

    // budget
    weeklyBudgetLbl.textContent = money(WEEKLY_BUDGET);
    dowLbl.textContent = dayNameRo(new Date());

    const spentWeek = sumWeekSpends(new Date());
    const remainWeek = Math.max(0, WEEKLY_BUDGET - spentWeek);
    const todaySpend = totalForDay(ymd());
    const allowance = calcTodayAllowance();

    spentWeekLbl.textContent = money(spentWeek);
    remainWeekLbl.textContent = money(remainWeek);
    todayAllowanceLbl.textContent = money(allowance);
    todaySpentLbl.textContent = money(todaySpend);

    if (todaySpend > allowance) budgetNote.textContent = `Azi ai depÄƒÈ™it È›inta cu ${money(todaySpend - allowance)}. MÃ¢ine compensezi uÈ™or.`;
    else budgetNote.textContent = `EÈ™ti bine: sub È›inta de azi cu ${money(allowance - todaySpend)}.`;

    // today expenses list
    const items = getTodayExpenses();
    todayList.innerHTML = "";
    if (!items.length) {
      todayList.innerHTML = `<li class="muted">Nu ai bonuri azi (Ã®ncÄƒ).</li>`;
    } else {
      for (const it of items) {
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `
          <div class="grow">
            <div><span class="amount">${money(it.amount)}</span> <span class="pill">${escapeHtml(it.cat)}</span></div>
            <div class="muted">${escapeHtml(it.note || "â€”")}</div>
          </div>
          <button class="btnDanger mini" data-id="${it.id}" style="width:auto;">X</button>
        `;
        todayList.appendChild(li);
      }
      todayList.querySelectorAll("button[data-id]").forEach(btn => {
        btn.addEventListener("click", () => {
          removeExpense(btn.getAttribute("data-id"));
          render();
        });
      });
    }

    // history 7 days
    const now = new Date();
    historyList.innerHTML = "";
    for (let i=0;i<7;i++){
      const d = new Date(now);
      d.setDate(now.getDate() - i);
      const k = ymd(d);
      const t = totalForDay(k);
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `
        <div class="grow">
          <div><b>${k}</b> <span class="pill">${dayNameRo(d)}</span></div>
          <div class="muted">${itemsCountText(k)}</div>
        </div>
        <div class="amount">${money(t)}</div>
      `;
      historyList.appendChild(li);
    }

    // meals
    const menu = pickMenuForToday(false);
    mealsBox.innerHTML = renderMenu(menu);
    mealBudgetLbl.textContent = money(allowance);
    mealSpentLbl.textContent = money(todaySpend);
    mealsStatus.textContent = mealsDoneToday() ? "âœ” Mesele sunt bifate azi." : "Mesele nu sunt bifate Ã®ncÄƒ.";

    // streak
    const st = getStreak();
    streakLbl.textContent = String(st.count || 0);
    lastDoneLbl.textContent = st.lastDone ? st.lastDone : "â€”";
    statusEl.textContent = st.lastDone === ymd() ? "âœ” Azi e bifatÄƒ. Èšine ritmul." : "ÃncÄƒ nu ai bifat azi.";

    // weekly report auto-show
    const decision = maybeShowWeeklyReport(meta);
    if (decision.show) {
      renderWeeklyReport(decision.weekKey);
      meta.lastReportedWeekId = decision.weekKey;
      meta.lastWeekId = weekIdForDate(new Date());
      meta.lastSeenYmd = ymd();
      saveJSON("meta", meta);
    }

    // notif status
    notifStatus.textContent = `Status notificÄƒri: ${("Notification" in window) ? Notification.permission : "nesuportat"}`;
  }

  function itemsCountText(dayKey){
    const all = getExpensesByDay();
    const arr = Array.isArray(all[dayKey]) ? all[dayKey] : [];
    return arr.length ? `${arr.length} bon(uri)` : `0 bonuri`;
  }

  function renderMenu(menu){
    return `
      <div class="card" style="margin:0 0 10px 0; box-shadow:none;">
        <b>Mic dejun:</b> ${escapeHtml(menu.breakfast.t)}<br>
        <span class="muted">${escapeHtml(menu.breakfast.notes)}</span>
      </div>
      <div class="card" style="margin:0 0 10px 0; box-shadow:none;">
        <b>PrÃ¢nz:</b> ${escapeHtml(menu.lunch.t)}<br>
        <span class="muted">${escapeHtml(menu.lunch.notes)}</span>
      </div>
      <div class="card" style="margin:0; box-shadow:none;">
        <b>CinÄƒ:</b> ${escapeHtml(menu.dinner.t)}<br>
        <span class="muted">${escapeHtml(menu.dinner.notes)}</span><br>
        <div class="hr"></div>
        <b>Tip:</b> ${escapeHtml(menu.tip)}
      </div>
    `;
  }

  function escapeHtml(s){
    return String(s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  // ===== Actions =====
  document.getElementById("addExpenseBtn").addEventListener("click", () => {
    const amount = document.getElementById("expAmount").value;
    const cat = document.getElementById("expCat").value;
    const note = document.getElementById("expNote").value;

    const ok = addExpense(amount, cat, note);
    if (!ok) return;

    document.getElementById("expAmount").value = "";
    document.getElementById("expNote").value = "";
    render();
  });

  document.getElementById("resetTodayBtn").addEventListener("click", () => {
    resetToday();
    render();
  });

  document.getElementById("exportCsvBtn").addEventListener("click", () => exportCsv7Days());

  document.getElementById("clearAllBtn").addEventListener("click", () => {
    // no confirm popup â€” safer: require long-press style? We'll do 2-step with localStorage flag
    const key = "clearAllArmed";
    const armed = localStorage.getItem(key) === "1";
    if (!armed) {
      localStorage.setItem(key,"1");
      alert("AtenÈ›ie: apasÄƒ Ã®ncÄƒ o datÄƒ pe â€È˜terge TOTâ€ ca sÄƒ confirmi.");
      return;
    }
    localStorage.removeItem(key);
    localStorage.removeItem("expensesByDay");
    localStorage.removeItem("streak");
    localStorage.removeItem("mealsByDay");
    localStorage.removeItem("meta");
    render();
  });

  document.getElementById("regenMealsBtn").addEventListener("click", () => {
    pickMenuForToday(true);
    render();
  });

  document.getElementById("markMealsDoneBtn").addEventListener("click", () => {
    markMealsDoneToday();
    render();
  });

  document.getElementById("doneBtn").addEventListener("click", () => { markDoneToday(); render(); });
  document.getElementById("undoBtn").addEventListener("click", () => { undoDoneToday(); render(); });

  document.getElementById("forceReportBtn").addEventListener("click", () => {
    const wk = weekIdForDate(new Date());
    renderWeeklyReport(wk);
    const meta = ensureMeta();
    meta.lastReportedWeekId = wk;
    saveJSON("meta", meta);
  });

  document.getElementById("enableNotifsBtn").addEventListener("click", async () => {
    const res = await enableNotifications();
    notifStatus.textContent = res.msg;
  });

  document.getElementById("testNotifBtn").addEventListener("click", async () => {
    const res = await enableNotifications();
    notifStatus.textContent = res.msg;
    if (res.ok) {
      if ("serviceWorker" in navigator) {
        const reg = await navigator.serviceWorker.getRegistration();
        if (reg) reg.showNotification("Rutina Mea", { body: "Test notificare âœ…" });
        else new Notification("Rutina Mea", { body: "Test notificare âœ…" });
      } else {
        new Notification("Rutina Mea", { body: "Test notificare âœ…" });
      }
    }
  });

  document.getElementById("calWakeBtn").addEventListener("click", () => addCalendarEvent("Rutina Mea â€” Trezire 05:50", 5, 50));
  document.getElementById("calDinnerBtn").addEventListener("click", () => addCalendarEvent("Rutina Mea â€” CinÄƒ 18:00", 18, 0));
  document.getElementById("calShopBtn").addEventListener("click", () => addCalendarEvent("Rutina Mea â€” CumpÄƒrÄƒturi 20:00", 20, 0));

  // Service worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  render();
</script>
</body>
</html><!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutina Mea</title>

  <meta name="theme-color" content="#2ecc71">
  <link rel="manifest" href="manifest.json" />

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px; }
    .card { background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    h1,h2{ margin:0 0 10px 0; }
    button { width:100%; padding:12px; border:0; border-radius:8px; background:#2ecc71; color:#fff; font-size:16px; }
    input { width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-top:6px; }
    .muted{color:#666; font-size:14px;}
    .row{display:flex; gap:10px;}
    .row > *{flex:1;}
    .btn2{background:#1f2937;}
    .btnWarn{background:#e67e22;}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:#eef2f7; font-size:13px; margin-right:6px;}
    .ok{background:#e8fff0;}
  </style>
</head>

<body>
  <h1>ğŸ“… Rutina Mea</h1>
  <p id="date" class="muted"></p>

  <div class="card">
    <h2>â° Program</h2>
    <p>Trezire: <b>05:50</b></p>
    <p>Lucru: <b>07:00</b></p>
    <p class="muted">Start: 1 ianuarie 2026</p>
  </div>

  <div class="card">
    <h2>ğŸ’° Buget (7 zile)</h2>
    <div style="margin-bottom:10px;">
      <span class="pill">Buget sÄƒptÄƒmÃ¢nal: <b id="weeklyBudgetLbl"></b></span>
      <span class="pill">Zi sÄƒptÄƒmÃ¢nÄƒ: <b id="dowLbl"></b></span>
    </div>

    <p class="muted" style="margin:0 0 10px 0;">
      SÄƒptÄƒmÃ¢na curentÄƒ (Luniâ€“DuminicÄƒ). AplicaÈ›ia face reset zilnic automat.
    </p>

    <div class="row" style="margin-bottom:10px;">
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Cheltuit sÄƒptÄƒmÃ¢na asta</div>
        <div style="font-size:20px;"><b id="spentWeekLbl"></b></div>
      </div>
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">RÄƒmas sÄƒptÄƒmÃ¢na asta</div>
        <div style="font-size:20px;"><b id="remainWeekLbl"></b></div>
      </div>
    </div>

    <div class="row" style="margin-bottom:10px;">
      <div class="card" style="margin:0; box-shadow:none;">
        <div class="muted">Èšinta pentru AZI (automat)</div>
        <div style="font-size:18px;"><b id="todayAllowanceLbl"></b></div>
      </div>
      <div class="card" style="margin:0; box-shadow:none;">
        <div class="muted">Cheltuit AZI</div>
        <div style="font-size:18px;"><b id="todaySpentLbl"></b></div>
      </div>
    </div>

    <label>Introdu totalul cheltuit azi (â‚¬):</label>
    <input type="number" id="spentTodayInput" placeholder="ex: 12.50" inputmode="decimal">

    <div style="height:10px"></div>
    <div class="row">
      <button id="saveTodayBtn">SalveazÄƒ azi</button>
      <button id="resetTodayBtn" class="btnWarn">Reset azi</button>
    </div>

    <p id="budgetNote" class="muted" style="margin-top:10px;"></p>
  </div>

  <div class="card">
    <h2>âœ… Ziua de azi (streak)</h2>
    <p class="muted" style="margin-top:0;">
      ApeÈ™i cÃ¢nd ai respectat ziua (fÄƒrÄƒ alcool / rutinÄƒ ok).
    </p>

    <div class="row" style="margin-bottom:10px;">
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Streak curent</div>
        <div style="font-size:22px;"><b id="streakLbl"></b> zile</div>
      </div>
      <div class="card ok" style="margin:0; box-shadow:none;">
        <div class="muted">Ultima zi bifatÄƒ</div>
        <div style="font-size:16px;"><b id="lastDoneLbl"></b></div>
      </div>
    </div>

    <div class="row">
      <button id="doneBtn">Am respectat ziua</button>
      <button id="undoBtn" class="btn2">AnuleazÄƒ azi</button>
    </div>

    <p id="status" class="muted" style="margin-top:10px;"></p>
  </div>

  <div class="card">
    <h2>ğŸ”” NotificÄƒri</h2>
    <p class="muted" style="margin-top:0;">
      Ãn browser/PWA fÄƒrÄƒ server, notificÄƒrile 100% â€ca alarmÄƒâ€ nu sunt mereu garantate.
      Dar poÈ›i:
      <br>âœ… activa notificÄƒri cÃ¢nd aplicaÈ›ia e deschisÄƒ
      <br>âœ… adÄƒuga orele Ã®n Calendar (notificÄƒri reale).
    </p>

    <div class="row" style="margin-bottom:10px;">
      <button id="enableNotifsBtn">ActiveazÄƒ notificÄƒrile</button>
      <button id="testNotifBtn" class="btn2">Test notificare</button>
    </div>

    <div class="row">
      <button id="calWakeBtn" class="btn2">AdaugÄƒ 05:50 Ã®n Calendar</button>
      <button id="calDinnerBtn" class="btn2">AdaugÄƒ 18:00 Ã®n Calendar</button>
    </div>
    <div style="height:10px"></div>
    <button id="calShopBtn" class="btn2">AdaugÄƒ 20:00 Ã®n Calendar</button>

    <p id="notifStatus" class="muted" style="margin-top:10px;"></p>
  </div>

  <script>
    // ====== SETTINGS ======
    const WEEKLY_BUDGET = 50;
    const REMINDERS = [
      { hh: 5, mm: 50, title: "Rutina Mea", body: "Trezire. Ãncepe uÈ™or: apÄƒ + 2 minute respiraÈ›ie." },
      { hh: 18, mm: 0, title: "Rutina Mea", body: "Cina: ceva simplu È™i sÄƒnÄƒtos. PregÄƒteÈ™te planul." },
      { hh: 20, mm: 0, title: "Rutina Mea", body: "CumpÄƒrÄƒturi pentru mÃ¢ine: ia strict ce trebuie." }
    ];

    // ====== HELPERS ======
    const money = (n) => `${Number(n).toFixed(2)} â‚¬`;

    function ymd(d = new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    // Monday start of week (ISO-like)
    function weekStartMonday(d = new Date()) {
      const x = new Date(d);
      const day = x.getDay(); // 0=Sun..6=Sat
      const diff = (day === 0 ? -6 : 1 - day); // move back to Monday
      x.setDate(x.getDate() + diff);
      x.setHours(0,0,0,0);
      return x;
    }

    function dayNameRo(d = new Date()) {
      return d.toLocaleDateString("ro-RO", { weekday: "long" });
    }

    function loadJSON(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key) || ""); }
      catch { return fallback; }
    }
    function saveJSON(key, obj) {
      localStorage.setItem(key, JSON.stringify(obj));
    }

    // ====== DATA MODEL ======
    // "dailySpends" : { "YYYY-MM-DD": number }
    // "streak" : { count: number, lastDone: "YYYY-MM-DD" }
    // "meta" : { lastSeen: "YYYY-MM-DD" }

    function ensureDailyReset() {
      const meta = loadJSON("meta", { lastSeen: null });
      const today = ymd();

      if (!meta.lastSeen) {
        meta.lastSeen = today;
        saveJSON("meta", meta);
        return;
      }

      if (meta.lastSeen !== today) {
        // New day detected: nothing special needed because we store per-day already.
        meta.lastSeen = today;
        saveJSON("meta", meta);
      }
    }

    function getDailySpends() {
      return loadJSON("dailySpends", {});
    }

    function setTodaySpend(amount) {
      const daily = getDailySpends();
      daily[ymd()] = Number(amount) || 0;
      saveJSON("dailySpends", daily);
    }

    function getTodaySpend() {
      const daily = getDailySpends();
      return Number(daily[ymd()] || 0);
    }

    function resetToday() {
      setTodaySpend(0);
    }

    function sumWeekSpends() {
      const daily = getDailySpends();
      const start = weekStartMonday(new Date());
      const startKey = ymd(start);
      let total = 0;

      // sum from start of week to today+6
      for (let i = 0; i < 7; i++) {
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        const k = ymd(d);
        total += Number(daily[k] || 0);
      }
      return { total, startKey };
    }

    function daysRemainingInWeek() {
      const d = new Date();
      const day = d.getDay(); // 0 Sun .. 6 Sat
      // convert to Monday=0..Sunday=6
      const idx = (day === 0) ? 6 : (day - 1);
      return 7 - idx; // including today
    }

    function calcTodayAllowance() {
      const { total: spentWeek } = sumWeekSpends();
      const remaining = Math.max(0, WEEKLY_BUDGET - spentWeek);
      const daysLeft = daysRemainingInWeek();
      return remaining / Math.max(1, daysLeft);
    }

    // ====== STREAK ======
    function getStreak() {
      return loadJSON("streak", { count: 0, lastDone: "" });
    }

    function setStreak(obj) {
      saveJSON("streak", obj);
    }

    function daysBetween(aYmd, bYmd) {
      const a = new Date(aYmd + "T00:00:00");
      const b = new Date(bYmd + "T00:00:00");
      const ms = b - a;
      return Math.round(ms / (1000*60*60*24));
    }

    function markDoneToday() {
      const today = ymd();
      const st = getStreak();

      if (!st.lastDone) {
        st.count = 1;
        st.lastDone = today;
        setStreak(st);
        return;
      }

      if (st.lastDone === today) {
        // already done today
        return;
      }

      const diff = daysBetween(st.lastDone, today);
      if (diff === 1) st.count += 1;
      else st.count = 1;

      st.lastDone = today;
      setStreak(st);
    }

    function undoDoneToday() {
      const today = ymd();
      const st = getStreak();
      if (st.lastDone !== today) return;

      // Roll back: safest simple behavior
      st.lastDone = "";
      st.count = 0;
      setStreak(st);
    }

    // ====== NOTIFICATIONS ======
    async function enableNotifications() {
      if (!("Notification" in window)) {
        return { ok:false, msg:"NotificÄƒrile nu sunt suportate pe acest dispozitiv/browser." };
      }
      const perm = await Notification.requestPermission();
      if (perm !== "granted") {
        return { ok:false, msg:"Permisiunea pentru notificÄƒri nu a fost acordatÄƒ." };
      }
      return { ok:true, msg:"NotificÄƒrile sunt activate. (Cele programate pot depinde de browser.)" };
    }

    function scheduleInAppReminders() {
      // Works when app is open; checks every 30s and triggers once per day per reminder
      const today = ymd();
      const firedKey = "firedReminders";
      const fired = loadJSON(firedKey, {});
      if (fired.date !== today) {
        fired.date = today;
        fired.items = {};
        saveJSON(firedKey, fired);
      }

      setInterval(() => {
        if (Notification.permission !== "granted") return;
        const now = new Date();
        const h = now.getHours(), m = now.getMinutes();
        for (const r of REMINDERS) {
          const id = `${r.hh}:${String(r.mm).padStart(2,"0")}`;
          if (h === r.hh && m === r.mm && !fired.items[id]) {
            fired.items[id] = true;
            saveJSON(firedKey, fired);
            // Try service worker notification (better), fallback to Notification()
            if ("serviceWorker" in navigator && navigator.serviceWorker.controller) {
              navigator.serviceWorker.getRegistration().then(reg => {
                if (reg) reg.showNotification(r.title, { body: r.body });
                else new Notification(r.title, { body: r.body });
              });
            } else {
              new Notification(r.title, { body: r.body });
            }
          }
        }
      }, 30000);
    }

    function addCalendarEvent(title, hh, mm) {
      // Creates an .ics file download (works on Android: opens calendar import)
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0);
      const end = new Date(start.getTime() + 10*60*1000); // 10 min

      // If time already passed today, schedule for tomorrow
      if (start < new Date()) {
        start.setDate(start.getDate() + 1);
        end.setDate(end.getDate() + 1);
      }

      function fmt(d) {
        const pad = (n)=>String(n).padStart(2,"0");
        return d.getFullYear()
          + pad(d.getMonth()+1)
          + pad(d.getDate())
          + "T"
          + pad(d.getHours())
          + pad(d.getMinutes())
          + "00";
      }

      const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Rutina Mea//RO
BEGIN:VEVENT
DTSTART:${fmt(start)}
DTEND:${fmt(end)}
RRULE:FREQ=DAILY
SUMMARY:${title}
DESCRIPTION:Rutina Mea reminder
END:VEVENT
END:VCALENDAR`;

      const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "rutina-mea.ics";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    // ====== UI ======
    const dateEl = document.getElementById("date");
    const weeklyBudgetLbl = document.getElementById("weeklyBudgetLbl");
    const dowLbl = document.getElementById("dowLbl");
    const spentWeekLbl = document.getElementById("spentWeekLbl");
    const remainWeekLbl = document.getElementById("remainWeekLbl");
    const todayAllowanceLbl = document.getElementById("todayAllowanceLbl");
    const todaySpentLbl = document.getElementById("todaySpentLbl");
    const spentTodayInput = document.getElementById("spentTodayInput");
    const budgetNote = document.getElementById("budgetNote");

    const streakLbl = document.getElementById("streakLbl");
    const lastDoneLbl = document.getElementById("lastDoneLbl");
    const statusEl = document.getElementById("status");

    const notifStatus = document.getElementById("notifStatus");

    function render() {
      ensureDailyReset();

      dateEl.textContent = new Date().toLocaleDateString("ro-RO", {
        weekday: "long", year: "numeric", month: "long", day: "numeric"
      });

      weeklyBudgetLbl.textContent = money(WEEKLY_BUDGET);
      dowLbl.textContent = dayNameRo(new Date());

      const todaySpend = getTodaySpend();
      spentTodayInput.value = todaySpend ? String(todaySpend) : "";
      todaySpentLbl.textContent = money(todaySpend);

      const { total: spentWeek } = sumWeekSpends();
      const remainWeek = Math.max(0, WEEKLY_BUDGET - spentWeek);

      spentWeekLbl.textContent = money(spentWeek);
      remainWeekLbl.textContent = money(remainWeek);

      const allowance = calcTodayAllowance();
      todayAllowanceLbl.textContent = money(allowance);

      if (todaySpend > allowance) {
        budgetNote.textContent = `Azi ai depÄƒÈ™it È›inta cu ${money(todaySpend - allowance)}. MÃ¢ine compensezi uÈ™or.`;
      } else {
        budgetNote.textContent = `EÈ™ti bine: sub È›inta de azi cu ${money(allowance - todaySpend)}.`;
      }

      const st = getStreak();
      streakLbl.textContent = String(st.count || 0);
      lastDoneLbl.textContent = st.lastDone ? st.lastDone : "â€”";
      statusEl.textContent = st.lastDone === ymd()
        ? "âœ” Azi e bifatÄƒ. Èšine ritmul."
        : "ÃncÄƒ nu ai bifat azi.";

      notifStatus.textContent = `Status notificÄƒri: ${("Notification" in window) ? Notification.permission : "nesuportat"}`;
    }

    document.getElementById("saveTodayBtn").addEventListener("click", () => {
      const v = Number(spentTodayInput.value || 0);
      setTodaySpend(v);
      render();
    });

    document.getElementById("resetTodayBtn").addEventListener("click", () => {
      resetToday();
      render();
    });

    document.getElementById("doneBtn").addEventListener("click", () => {
      markDoneToday();
      render();
    });

    document.getElementById("undoBtn").addEventListener("click", () => {
      undoDoneToday();
      render();
    });

    document.getElementById("enableNotifsBtn").addEventListener("click", async () => {
      const res = await enableNotifications();
      notifStatus.textContent = res.msg;
      if (res.ok) scheduleInAppReminders();
    });

    document.getElementById("testNotifBtn").addEventListener("click", async () => {
      const res = await enableNotifications();
      notifStatus.textContent = res.msg;
      if (res.ok) {
        if ("serviceWorker" in navigator) {
          const reg = await navigator.serviceWorker.getRegistration();
          if (reg) reg.showNotification("Rutina Mea", { body: "Test notificare âœ…" });
          else new Notification("Rutina Mea", { body: "Test notificare âœ…" });
        } else {
          new Notification("Rutina Mea", { body: "Test notificare âœ…" });
        }
      }
    });

    document.getElementById("calWakeBtn").addEventListener("click", () => {
      addCalendarEvent("Rutina Mea â€” Trezire 05:50", 5, 50);
    });
    document.getElementById("calDinnerBtn").addEventListener("click", () => {
      addCalendarEvent("Rutina Mea â€” CinÄƒ 18:00", 18, 0);
    });
    document.getElementById("calShopBtn").addEventListener("click", () => {
      addCalendarEvent("Rutina Mea â€” CumpÄƒrÄƒturi 20:00", 20, 0);
    });

    // Service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }

    render();

    // If already allowed, schedule in-app reminders
    if (("Notification" in window) && Notification.permission === "granted") {
      scheduleInAppReminders();
    }
  </script>
</body>
</html><!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutina Mea</title>

  <meta name="theme-color" content="#2ecc71">
  <link rel="manifest" href="manifest.json" />

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px; }
    .card { background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    h1,h2{ margin:0 0 10px 0; }
    button { width:100%; padding:12px; border:0; border-radius:8px; background:#2ecc71; color:#fff; font-size:16px; }
    input { width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-top:6px; }
    .muted{color:#666; font-size:14px;}
    .row{display:flex; gap:10px;}
    .row > *{flex:1;}
    .btn<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutina Mea</title>

  <meta name="theme-color" content="#2ecc71">
  <link rel="manifest" href="manifest.json" />

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px; }
    .card { background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    h1,h2{ margin:0 0 10px 0; }
    button { width:100%; padding:12px; border:0; border-radius:8px; background:#2ecc71; color:#fff; font-size:16px; }
    input { width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-top:6px; }
    .muted{color:#666; font-size:14px;}
  </style>
</head>

<body>
  <h1>ğŸ“… Rutina Mea</h1>
  <p id="date" class="muted"></p>

  <div class="card">
    <h2>â° Program</h2>
    <p>Trezire: <b>05:50</b></p>
    <p>Lucru: <b>07:00</b></p>
    <p class="muted">Start: 1 ianuarie 2026</p>
  </div>

  <div class="card">
    <h2>ğŸ½ Buget mÃ¢ncare</h2>
    <p>Buget sÄƒptÄƒmÃ¢nal: <b>50 â‚¬</b></p>
    <label>Cheltuit azi:</label>
    <input type="number" id="spent" placeholder="â‚¬" inputmode="decimal">
    <div style="height:10px"></div>
    <button id="saveBtn">SalveazÄƒ</button>
    <p id="remaining" class="muted" style="margin-top:10px;"></p>
  </div>

  <div class="card">
    <h2>âœ… Ziua de azi</h2>
    <button id="doneBtn">Am respectat ziua</button>
    <p id="status" class="muted" style="margin-top:10px;"></p>
  </div>

  <script>
    const WEEKLY_BUDGET = 50;

    const dateEl = document.getElementById("date");
    const spentEl = document.getElementById("spent");
    const remainingEl = document.getElementById("remaining");
    const statusEl = document.getElementById("status");

    dateEl.textContent = new Date().toLocaleDateString("ro-RO", {
      weekday: "long", year: "numeric", month: "long", day: "numeric"
    });

    function load() {
      const spent = Number(localStorage.getItem("spentToday") || 0);
      spentEl.value = spent ? String(spent) : "";
      remainingEl.textContent = "Buget rÄƒmas azi: " + (WEEKLY_BUDGET - spent).toFixed(2) + " â‚¬";

      const lastDone = localStorage.getItem("dayDone") || "";
      statusEl.textContent = lastDone ? ("âœ” Zi respectatÄƒ (" + lastDone + "). FÄƒrÄƒ alcool. ContinuÄƒ!") : "";
    }

    document.getElementById("saveBtn").addEventListener("click", () => {
      const spent = Number(spentEl.value || 0);
      localStorage.setItem("spentToday", String(spent));
      remainingEl.textContent = "Buget rÄƒmas azi: " + (WEEKLY_BUDGET - spent).toFixed(2) + " â‚¬";
    });

    document.getElementById("doneBtn").addEventListener("click", () => {
      const stamp = new Date().toLocaleDateString("ro-RO");
      localStorage.setItem("dayDone", stamp);
      statusEl.textContent = "âœ” Zi respectatÄƒ (" + stamp + "). FÄƒrÄƒ alcool. ContinuÄƒ!";
    });

    // PWA service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js");
    }

    load();
  </script>
</body>
</html>
<h1>ğŸ“… Rutina Mea</h1><h1>ğŸ“… Rutina Mea</h1>

<div class="card warnBox">
  <h2>ğŸ§¾ Plan financiar lunar</h2>
  <p class="muted" style="margin-top:0;">
    StructurÄƒ fixÄƒ. Nu te mai gÃ¢ndeÈ™ti zilnic.
  </p>

  <ul class="list">
    <li class="item"><div class="grow">ğŸ’¼ Venit lunar</div><b id="incomeLbl"></b></li>
    <li class="item"><div class="grow">ğŸ  Cheltuieli fixe</div><b id="fixedLbl"></b></li>
    <li class="item"><div class="grow">ğŸ½ MÃ¢ncare</div><b id="foodLbl"></b></li>
    <li class="item"><div class="grow">ğŸ’£ Datorii (È›intÄƒ)</div><b id="debtTargetLbl"></b></li>
    <li class="item ok"><div class="grow">ğŸŸ¢ RÄƒmas pentru tine</div><b id="freeLbl"></b></li>
  </ul>
</div>

<div class="card">
  <h2>ğŸ’£ Datorii</h2>
  <p class="muted" style="margin-top:0;">
    Nu conteazÄƒ cui. ConteazÄƒ sÄƒ respecÈ›i suma.
  </p>

  <div class="row" style="margin-bottom:10px;">
    <div class="card ok" style="margin:0; box-shadow:none;">
      <div class="muted">ÈšintÄƒ lunarÄƒ</div>
      <div style="font-size:22px;"><b id="debtTargetBig"></b></div>
    </div>
    <div class="card ok" style="margin:0; box-shadow:none;">
      <div class="muted">Status luna curentÄƒ</div>
      <div style="font-size:16px;"><b id="debtStatus"></b></div>
    </div>
  </div>

  <button id="payDebtBtn">Am pus banii la datorii</button>
</div>
